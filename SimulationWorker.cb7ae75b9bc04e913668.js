!function(t){var e={};function n(r){if(e[r])return e[r].exports;var u=e[r]={i:r,l:!1,exports:{}};return t[r].call(u.exports,u,u.exports,n),u.l=!0,u.exports}n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var u in t)n.d(r,u,function(e){return t[e]}.bind(null,u));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="https://renato-bohler.github.io/logossim/",n(n.s=0)}([function(t,e,n){"use strict";function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function u(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function o(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?u(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function a(t,e){if(t){if("string"===typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(t,e):void 0}}function s(t){return function(t){if(Array.isArray(t))return i(t)}(t)||function(t){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||a(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(t)){var n=[],r=!0,u=!1,o=void 0;try{for(var i,a=t[Symbol.iterator]();!(r=(i=a.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(s){u=!0,o=s}finally{try{r||null==a.return||a.return()}finally{if(u)throw o}}return n}}(t,e)||a(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}n.r(e);var l=function(t){var e=function(e){return t.find((function(t){return e===t.id}))},n=function(t){return[].concat(s(t.map((function(t){return e(t).source}))),s(t.map((function(t){return e(t).target})))).filter((function(t){return t&&!t.input}))},r=function(t){return[].concat(s(t.map((function(t){return e(t).source}))),s(t.map((function(t){return e(t).target})))).filter((function(t){return t&&t.input}))},u=[];return t.filter((function(t){return!t.isBifurcation})).forEach((function(t){if(!u.find((function(e){return t.id in e}))){var n={};!function t(n,r){n&&!(n.id in r)&&(r[n.id]=!0,t(e(n.bifurcation.source),r),t(e(n.bifurcation.target),r),n.bifurcations.forEach((function(n){return t(e(n),r)})))}(t,n),u.push(n)}})),u.map((function(t){return Object.keys(t)})).map((function(t){return{bits:e(t[0]).bits,links:t,inputs:n(t),outputs:r(t)}}))},p=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if("number"!==typeof t)return t;var n=4294967295,r=n>>>32-e;return t&r},m=function(t){return null===t||Array.isArray(t)&&t.every((function(t){return"number"===typeof t}))},y=function(t){return t.some((function(t){return"e"===(e=t.value)||Array.isArray(e)&&e.some((function(t){return"e"===t}));var e}))},d=function(t){return"x"===t||Array.isArray(t)&&t.some((function(t){return"x"===t}))},v=function(t){return self.circuit&&self.circuit.components.find((function(e){return e.id===t}))||null},b=function(t,e){self.diff.components[t.id]||(self.diff.components[t.id]={output:{},properties:{}}),self.diff.components[t.id]=o(o({},self.diff.components[t.id]),{},{output:e||self.diff.components[t.id].output,properties:t.getProperties()})},h=function(){function t(e,n){var r=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Object.entries(e).forEach((function(t){var e=f(t,2),n=e[0],u=e[1];r[n]=u})),Object.entries(n).forEach((function(t){var e=f(t,2),n=e[0],u=e[1];r[n]=u.bind(r)})),this.initialize(e.configurations)}var e,n,u;return e=t,(n=[{key:"getPort",value:function(t){return[].concat(s(this.ports.input),s(this.ports.output)).find((function(e){return e.name===t}))}},{key:"getInputPort",value:function(t){return this.ports.input.find((function(e){return e.name===t}))}},{key:"getOutputPort",value:function(t){return this.ports.output.find((function(e){return e.name===t}))}},{key:"setValues",value:function(t,e){this.ports[e]=this.ports[e].map((function(e){var n=e.value,r=n,u=!1;void 0!==t[e.name]&&("number"===typeof(r=t[e.name])?r=t[e.name].asArray(e.bits):"x"===r||"e"===r?(r=Array(e.bits).fill(r),u=!0):Array.isArray(r)||(u=!0)),r=r.map((function(t){var n,r;return"x"===t?null!==(n=e.defaultFloatingValue)&&void 0!==n?n:"x":"e"===t?null!==(r=e.defaultErrorValue)&&void 0!==r?r:"e":t})),n.some((function(t){return"x"===t||"e"===t}))&&(u=!0);var i=!u&&n<r,a=!u&&n>r;return o(o({},e),{},{value:r,meta:{previous:n,risingEdge:i,fallingEdge:a}})}))}},{key:"setInputValues",value:function(t){this.setValues(t,"input")}},{key:"setOutputValues",value:function(t){this.setValues(t,"output")}},{key:"setWireValues",value:function(t){this.ports.output=this.ports.output.map((function(e){return t[e.name]?o(o({},e),{},{linkValue:t[e.name]}):e}))}},{key:"hasOutputChanged",value:function(t){var e=this;return!Object.keys(t).every((function(n){return r=t[n],u=e.ports.output.find((function(t){return t.name===n})).value,r.map((function(t,e){return t===u[e]})).every(Boolean);var r,u}))}},{key:"getProperties",value:function(){var t=this,e=Object.keys(this).filter((function(t){return!["id","initialize","configurations","ports"].includes(t)}));return JSON.parse(JSON.stringify(e.filter((function(e){return"function"!==typeof t[e]})).reduce((function(e,n){return o(o({},e),{},r({},n,t[n]))}),{})))}},{key:"onSimulationStart",value:function(){}},{key:"onSimulationPause",value:function(){}},{key:"onSimulationStop",value:function(){}},{key:"step",value:function(){return{}}},{key:"stepError",value:function(){return this.ports.output.reduce((function(t,e){return o(o({},t),{},r({},e.name,Array(e.bits).fill("e")))}),{})}},{key:"stepFloating",value:function(){return this.ports.output.reduce((function(t,e){return o(o({},t),{},r({},e.name,Array(e.bits).fill("x")))}),{})}},{key:"emit",value:function(t){var e=new MessageEvent("message",{data:{command:"emit",emitted:{from:this.id,value:t}}});self.dispatchEvent(e)}},{key:"addInputPort",value:function(){}},{key:"addOutputPort",value:function(){}},{key:"removePort",value:function(){}},{key:"createAudio",value:function(t,e){this.audioCount||(this.audioCount=0);var n="".concat(this.audioCount,"-").concat(this.id);return this.audioCount+=1,postMessage({type:"audio",payload:{command:"create",id:n,frequency:t,waveform:e.toLowerCase()}}),{play:function(){return postMessage({type:"audio",payload:{command:"play",id:n}})},pause:function(){return postMessage({type:"audio",payload:{command:"pause",id:n}})},setFrequency:function(t){return postMessage({type:"audio",payload:{command:"setFrequency",id:n,frequency:t}})},setWaveform:function(t){return postMessage({type:"audio",payload:{command:"setWaveform",id:n,waveform:t}})}}}}])&&c(e.prototype,n),u&&c(e,u),t}(),g=function(t){return Object.fromEntries(Object.entries(t.methods).map((function(t){var e=f(t,2),n=e[0],r=e[1];return[n,new Function("return function ".concat(r))()]})))},O=function(t){return o(o({},t),{},{value:new Array(t.bits||1).fill(t.defaultFloatingValue),linkValue:new Array(t.bits||1).fill(t.defaultFloatingValue),getValue:function(){return this.value},getWireValue:function(){return this.linkValue}})},w=function(t){var e=function(t){return t.map((function(t){return o(o({},t),{},{methods:g(t)})})).reduce((function(t,e){return o(o({},t),{},r({},e.type,e.methods))}),{})}(t.models);return{components:t.components.map((function(t){return new h(o(o({},t.properties),{},{id:t.id,configurations:t.configurations,ports:{input:t.ports.filter((function(t){return t.input})).map(O),output:t.ports.filter((function(t){return!t.input})).map(O)}}),e[t.type])})),meshes:l(t.links)}};Array.prototype.asArray=function(){return this},Array.prototype.asNumber=function(){if(this.some((function(t){return"e"===t})))return"e";if(this.some((function(t){return"x"===t})))return"x";if(this.some((function(t){return 0!==t&&1!==t})))throw new Error("[logossim] Array cannot be converted to number because it contains invalid values");return this.slice().reverse().reduce((function(t,e,n){return t+e*Math.pow(2,n)}),0)},Array.prototype.transpose=function(){var t=this;return this[0].map((function(e,n){return t.map((function(t){return t[n]}))}))},Number.prototype.asNumber=function(){return Number(this)},Number.prototype.asArray=function(t){if(!t)throw new Error("[logossim] To transform a number to array, you need to pass as argument the length of the array");var e=s(this.toString(2)).map(Number);return Array(t).fill(0).concat(e).slice(e.length)},String.prototype.asArray=function(t){if(!t)throw new Error("[logossim] To transform a number to array, you need to pass as argument the length of the array");return s(this.padStart(t,0)).map((function(t){return"0"===t?0:"1"===t?1:t}))},String.prototype.parseBinary=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!t)throw new Error("[logossim] To parse a binary, you need to pass the value length in bits as first argument.");if(!e)throw new Error("[logossim] To parse a binary, you need to pass the result array length as second argument.");var r=/[^01]/g,u=new RegExp(".{1,".concat(t,"}"),"g"),o=(this.replace(r,"").match(u)||[]).map((function(t){return parseInt(t,2)}));return Array(e).fill(n).map((function(t,e){var n=o[e];return n||t}))},self.circuit=null,self.diff=null,self.emitQueue=[],self.stepQueue=[],self.workInterval=null,self.addEventListener("message",({data:{command:t,diagram:e,emitted:n}})=>{switch(t){case"start":void 0!==e&&(self.circuit=w(e),self.diff={components:{},links:{}},function(){self.circuit.components.forEach((function(t){t.setInputValues(Object.fromEntries(t.ports.input.map((function(t){return[t.id,new Array(t.bits||1).fill("x")]})))),t.setOutputValues(Object.fromEntries(t.ports.output.map((function(t){return[t.id,new Array(t.bits||1).fill("x")]}))))}));var t=self.circuit.meshes.map((function(t){return t.links})).flat().reduce((function(t,e){var n=self.circuit.meshes.find((function(t){return t.links.includes(e)})).bits;return o(o({},t),{},r({},e,Array(n).fill("x")))}),{}),e=Object.fromEntries(self.circuit.components.map((function(t){return[t.id,{output:Object.fromEntries([].concat(s(t.ports.input),s(t.ports.output)).map((function(t){return[t.name,new Array(t.bits||1).fill("x")]}))),properties:t.getProperties()}]})));postMessage({type:"diff",payload:{links:t,components:e}})}()),self.circuit.components.forEach(t=>t.onSimulationStart()),j(!0,!0),self.workInterval=setInterval(j);break;case"pause":self.circuit.components.forEach(t=>t.onSimulationPause()),clearInterval(self.workInterval);break;case"stop":self.circuit.components.forEach(t=>t.onSimulationStop()),clearInterval(self.workInterval),setTimeout(()=>{postMessage({type:"clear"}),self.circuit=null,self.diff=null,self.emitQueue=[],self.stepQueue=[]});break;case"emit":self.circuit&&self.emitQueue.push({...n,from:v(n.from)})}});const j=(t=!0,e=!1)=>{if(!self.circuit)return;const n=self.emitQueue.shift();if(!n)return;const r=n.from;n.value=Object.fromEntries(Object.entries(n.value).map(([t,e])=>{if(d(e))return[t,e];const{bits:n}=r.getOutputPort(t);let u=e;return"number"===typeof u?u=p(e,n).asArray(n):"x"!==u&&"e"!==u||(u=Array(n).fill(u)),[t,m(u)?u:Array(n).fill("e")]})),r.setOutputValues(n.value),b(r,n.value),A(n),k(e),j(!1),t&&(postMessage({type:"diff",payload:self.diff}),self.diff={components:{},links:{}})},k=(t=!1)=>{const e=self.stepQueue.shift();if(!e)return;const n=e.ports.input.reduce((t,e)=>({...t,[e.name]:e.value}),{}),r=e.ports.input.reduce((t,e)=>({...t,[e.name]:e.meta}),{});let u={};if(u=function(t){return t.every((function(t){return m(t.value,t.bits)}))}(e.ports.input)?e.step(Object.fromEntries(Object.entries(n).map(([t,e])=>[t,e.asNumber()])),r):y(e.ports.input)?e.stepError(n,r):function(t){return t.some((function(t){return d(t.value)}))}(e.ports.input)?e.stepFloating(n,r):e.stepError(n,r),!u)return b(e),void k();u=Object.fromEntries(Object.entries(u||{}).map(([t,n])=>{const{bits:r}=e.getOutputPort(t);let u=n;return"number"===typeof u?u=p(n,r).asArray(r):"x"!==u&&"e"!==u||(u=Array(r).fill(u)),[t,u]}));const o=Object.fromEntries(Object.entries(u).filter(([t])=>e.getOutputPort(t)));t||e.hasOutputChanged(o)?(e.setOutputValues(o),b(e,o),A({from:e,value:o})):b(e),k()},A=t=>{(function(t){return self.circuit.meshes.filter((function(e){return e.inputs.some((function(e){return t.from.id===e.componentId&&Object.keys(t.value).includes(e.name)}))}))})(t).forEach(t=>{const e=function(t){var e=t.inputs.map((function(t){var e=v(t.componentId).getOutputPort(t.name);return e?e.value:null})).filter((function(t){return null!==t}));return s(Array(e[0].length).keys()).map((function(t){return e.map((function(e){return e[t]}))})).map((function(t){var e=t.find((function(t){return"number"===typeof t}));return t.every((function(t){return t===e||"x"===t}))?"number"===typeof e?e:"x":"e"}))}(t);t.links.forEach(t=>{self.diff.links[t]=e});(function(t){return s(new Set(t.outputs.map((function(t){return t.componentId})))).map((function(t){return v(t)}))})(t).forEach(n=>{const r=t.outputs.filter(t=>t.componentId===n.id).map(t=>t.name).reduce((t,n)=>({...t,[n]:e}),{});n.setInputValues(r),b(n,r),self.stepQueue.push(n)});(function(t){return s(new Set(t.inputs.map((function(t){return t.componentId})))).map((function(t){return v(t)}))})(t).forEach(n=>{const r=t.inputs.filter(t=>t.componentId===n.id).map(t=>t.name).reduce((t,n)=>({...t,[n]:e}),{});n.setWireValues(r)})})}}]);
//# sourceMappingURL=SimulationWorker.cb7ae75b9bc04e913668.js.map